<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App de Pedidos - Lanchonete</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }
        .sticky-cart {
            position: sticky;
            top: 2rem; /* 32px */
        }
        /* Animação para o modal */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 200ms ease-out;
        }
        .modal-leave-active {
            opacity: 0;
            transform: scale(0.95);
            transition: all 200ms ease-in;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <!-- Container Principal -->
    <div class="container mx-auto px-4 py-8">

        <!-- Cabeçalho -->
        <header class="text-center mb-12 relative">
            <h1 id="lanchonete-name" class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">Lanchonete Sabor Digital</h1>
            <p class="text-gray-400 mt-2">Escolha seus lanches favoritos e faça seu pedido!</p>
            <!-- Botão de Administração -->
            <button id="admin-button" class="absolute top-0 right-0 bg-gray-700 hover:bg-gray-600 p-3 rounded-full transition-colors" title="Gerenciar Cardápio">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
        </header>

        <!-- Layout Principal (Menu e Carrinho) -->
        <main class="lg:flex lg:gap-8">
            <!-- Coluna do Menu (Esquerda) -->
            <div id="menu-container" class="lg:w-2/3 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Os itens do menu serão inseridos aqui pelo JavaScript -->
            </div>
            <!-- Coluna do Carrinho (Direita) -->
            <div class="lg:w-1/3 mt-10 lg:mt-0">
                <div class="sticky-cart bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold border-b border-gray-700 pb-3 mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart mr-2"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
                        Seu Pedido
                    </h2>
                    <div id="cart-items" class="space-y-4"></div>
                    <div id="empty-cart-message" class="text-center py-8 text-gray-400">
                        <p>Seu carrinho está vazio.</p>
                        <p class="text-sm">Adicione itens do cardápio para começar.</p>
                    </div>
                    <div id="cart-footer" class="mt-6 border-t border-gray-700 pt-4 hidden">
                        <div class="flex justify-between items-center text-xl font-bold mb-4">
                            <span>Total:</span>
                            <span id="total-price">R$ 0,00</span>
                        </div>
                        <button id="checkout-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                            Finalizar Pedido
                        </button>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Display da Senha do Último Pedido -->
        <div id="last-order-info" class="text-center my-8 p-4 bg-gray-800 rounded-lg hidden">
            <p class="text-gray-400">Senha do seu último pedido:</p>
            <p class="text-3xl font-bold text-indigo-400">
                <span id="last-order-password"></span>
            </p>
        </div>

    </div>
    
    <!-- Modal para Nome do Cliente -->
    <div id="customer-name-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-sm w-11/12 text-center shadow-2xl modal-enter">
            <h3 class="text-2xl font-bold mb-4">Identificação do Pedido</h3>
            <p class="text-gray-400 mb-6">Por favor, informe seu nome para continuar.</p>
            <form id="customer-name-form">
                <div>
                    <label for="customer-name" class="block text-sm font-medium text-gray-300 text-left mb-1">Seu Nome</label>
                    <input type="text" id="customer-name" required class="block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <p id="order-error-message" class="text-red-400 text-sm mt-2 h-4"></p>
                <div class="mt-4 flex gap-2">
                    <button type="button" id="cancel-name-modal-button" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" id="submit-order-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Confirmar Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Pedido -->
    <div id="order-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-md w-11/12 text-center shadow-2xl modal-enter">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-200 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check text-green-700"><path d="M20 6 9 17l-5-5"/></svg>
            </div>
            <h3 class="text-2xl font-bold mb-2">Pedido Enviado!</h3>
            
            <div class="my-6">
                <p class="text-gray-400">Anote ou tire um print da sua senha:</p>
                <p id="order-password" class="text-5xl font-bold text-indigo-400 tracking-wider">---</p>
            </div>

            <p class="text-gray-400 mb-6">Para concluir, realize o pagamento via Pix, envie o comprovante para nosso WhatsApp 993584738 ou mostre-o na retirada do pedido. Seu pedido será preparado em seguida - AGUARDE SUA SENHA SER CHAMADA.</p>
            
            <div class="bg-gray-900 rounded-lg p-4 mb-6 text-left">
                <div class="space-y-1">
                    <p class="text-sm text-gray-400">Nome: <span class="font-semibold text-white">Erislane Pereira</span></p>
                    <p class="text-sm text-gray-400">Banco: <span class="font-semibold text-white">Banco Mercado Pago</span></p>
                </div>
                <p class="text-sm text-gray-400 mt-3">Chave Pix (CPF):</p>
                <div class="flex items-center gap-2 mt-1">
                    <input id="pix-key-input" type="text" readonly value="61010913336" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white select-all focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="copy-pix-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-lg transition-all flex items-center gap-2 shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                        <span id="copy-pix-text">Copiar</span>
                    </button>
                </div>
            </div>
            <p class="text-sm text-gray-500 mt-6">Para fazer um novo pedido, basta atualize a página.</p>
        </div>
    </div>

    <!-- Modal de Senha do Admin -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-sm w-11/12 text-center shadow-2xl modal-enter">
            <h3 class="text-2xl font-bold mb-4">Acesso Restrito</h3>
            <p class="text-gray-400 mb-6">Por favor, insira a senha de administrador para continuar.</p>
            <form id="password-form">
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-300 text-left mb-1">Senha</label>
                    <input type="password" id="admin-password" required class="block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <p id="password-error-message" class="text-red-400 text-sm mt-2 h-4"></p>
                <div class="mt-4 flex gap-2">
                    <button type="button" id="cancel-password-modal-button" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Entrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Administração -->
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-6 md:p-8 w-11/12 max-w-4xl shadow-2xl modal-enter max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Painel de Administração</h2>
                <button id="close-admin-modal-button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            
            <div class="mb-6 border-b border-gray-700 pb-6">
                <h3 class="text-xl font-semibold mb-4">Configurações Gerais</h3>
                <form id="config-form" class="flex flex-col sm:flex-row items-end gap-4">
                    <div class="flex-grow w-full">
                        <label for="config-name" class="block text-sm font-medium text-gray-300">Nome da Lanchonete</label>
                        <input type="text" id="config-name" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors w-full sm:w-auto">Salvar Nome</button>
                </form>
            </div>

            <h3 class="text-xl font-semibold mb-4">Gerenciar Cardápio</h3>
            <div class="md:flex md:gap-8 flex-grow overflow-hidden">
                <div class="md:w-1/3 mb-8 md:mb-0 flex flex-col overflow-y-auto pr-2">
                    <h4 id="form-title" class="text-lg font-medium mb-3 shrink-0">Adicionar Novo Item</h4>
                    <form id="menu-item-form" class="space-y-4">
                        <input type="hidden" id="item-id">
                        <div>
                            <label for="item-name" class="block text-sm font-medium text-gray-300">Nome</label>
                            <input type="text" id="item-name" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="item-description" class="block text-sm font-medium text-gray-300">Descrição</label>
                            <textarea id="item-description" rows="3" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                        </div>
                        <div>
                            <label for="item-price" class="block text-sm font-medium text-gray-300">Preço (ex: 25.50)</label>
                            <input type="number" step="0.01" id="item-price" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="item-stock" class="block text-sm font-medium text-gray-300">Estoque</label>
                            <input type="number" id="item-stock" required class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="flex gap-2">
                             <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Salvar Item</button>
                             <button type="button" id="cancel-edit-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors hidden">Cancelar</button>
                        </div>
                    </form>
                </div>
                
                <div class="md:w-2/3 flex-grow overflow-y-auto pr-2">
                    <h4 class="text-lg font-medium mb-3">Itens Atuais</h4>
                    <div id="admin-menu-list" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, runTransaction, doc, onSnapshot, query, updateDoc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- ESTADO GLOBAL E VARIÁVEIS ---
            let db;
            let menuItems = [];
            let cart = [];
            let editingItemId = null;
            let lanchoneteConfig = { name: "Lanchonete Sabor Digital" };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            // --- SELEÇÃO DE ELEMENTOS DO DOM ---
            const lanchoneteNameElement = document.getElementById('lanchonete-name');
            const menuContainer = document.getElementById('menu-container');
            const cartItemsContainer = document.getElementById('cart-items');
            const emptyCartMessage = document.getElementById('empty-cart-message');
            const cartFooter = document.getElementById('cart-footer');
            const totalPriceElement = document.getElementById('total-price');
            const checkoutButton = document.getElementById('checkout-button');
            const orderModal = document.getElementById('order-modal');
            const customerNameModal = document.getElementById('customer-name-modal');
            const customerNameForm = document.getElementById('customer-name-form');
            const cancelNameModalButton = document.getElementById('cancel-name-modal-button');
            const adminButton = document.getElementById('admin-button');
            const adminModal = document.getElementById('admin-modal');
            const closeAdminModalButton = document.getElementById('close-admin-modal-button');
            const passwordModal = document.getElementById('password-modal');
            const passwordForm = document.getElementById('password-form');
            const cancelPasswordModalButton = document.getElementById('cancel-password-modal-button');
            const passwordErrorMessage = document.getElementById('password-error-message');
            const configForm = document.getElementById('config-form');
            const configNameInput = document.getElementById('config-name');
            const adminMenuList = document.getElementById('admin-menu-list');
            const menuItemForm = document.getElementById('menu-item-form');
            const formTitle = document.getElementById('form-title');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');
            const orderPasswordElement = document.getElementById('order-password');
            const orderErrorMessage = document.getElementById('order-error-message');

            // --- FUNÇÕES ---
            const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const renderLanchoneteName = () => lanchoneteNameElement.textContent = lanchoneteConfig.name;

            const rerenderAll = () => {
                renderLanchoneteName();
                renderMenuItems();
                renderCart();
                renderAdminMenuList();
            }

            const renderMenuItems = () => {
                menuContainer.innerHTML = '';
                if(menuItems.length === 0) {
                    menuContainer.innerHTML = `<p class="text-gray-400 col-span-full text-center">Carregando cardápio...</p>`;
                    return;
                }
                menuItems.forEach(item => {
                    const menuItemElement = document.createElement('div');
                    menuItemElement.className = 'bg-gray-800 rounded-xl shadow-lg transform hover:-translate-y-1 transition-transform duration-300 flex flex-col p-4';
                    
                    const stock = item.stock ?? 0;
                    const isAvailable = stock > 0;

                    menuItemElement.innerHTML = `
                        <div class="flex flex-col flex-grow">
                            <h3 class="text-xl font-bold mb-2">${item.name}</h3>
                            <p class="text-gray-400 text-sm mb-4 flex-grow">${item.description}</p>
                             <p class="text-sm mb-2 ${stock > 5 ? 'text-gray-400' : 'text-yellow-400'}">
                                ${isAvailable ? `${stock} em estoque` : 'Esgotado'}
                            </p>
                            <div class="flex justify-between items-center mt-auto">
                                <span class="text-2xl font-bold text-green-400">${formatCurrency(item.price)}</span>
                                <button data-id="${item.id}" class="add-to-cart-btn bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors ${!isAvailable ? 'opacity-50 cursor-not-allowed' : ''}" ${!isAvailable ? 'disabled' : ''}>
                                    ${isAvailable ? 'Adicionar' : 'Esgotado'}
                                </button>
                            </div>
                        </div>`;
                    menuContainer.appendChild(menuItemElement);
                });
            };

            const renderCart = () => {
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0) {
                    emptyCartMessage.style.display = 'block';
                    cartFooter.style.display = 'none';
                } else {
                    emptyCartMessage.style.display = 'none';
                    cartFooter.style.display = 'block';
                    cart.forEach(cartItem => {
                        const cartItemElement = document.createElement('div');
                        cartItemElement.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-lg';
                        cartItemElement.innerHTML = `
                            <div class="flex-grow">
                                <p class="font-semibold">${cartItem.name}</p>
                                <p class="text-sm text-gray-400">${formatCurrency(cartItem.price)}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-id="${cartItem.id}" class="decrease-quantity-btn bg-gray-600 hover:bg-gray-500 rounded-full w-6 h-6 flex items-center justify-center">-</button>
                                <span class="font-bold w-4 text-center">${cartItem.quantity}</span>
                                <button data-id="${cartItem.id}" class="increase-quantity-btn bg-gray-600 hover:bg-gray-500 rounded-full w-6 h-6 flex items-center justify-center">+</button>
                                <button data-id="${cartItem.id}" class="remove-from-cart-btn text-red-500 hover:text-red-400 p-1 rounded-full ml-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                </button>
                            </div>`;
                        cartItemsContainer.appendChild(cartItemElement);
                    });
                }
                updateTotal();
            };

            const renderAdminMenuList = () => {
                adminMenuList.innerHTML = '';
                 if(menuItems.length === 0) {
                    adminMenuList.innerHTML = `<p class="text-gray-400 text-center">Nenhum item cadastrado.</p>`;
                    return;
                }
                menuItems.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-lg';
                    itemElement.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-gray-400">Estoque: ${item.stock ?? 0}</p>
                            <p class="text-sm text-green-400">${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button data-id="${item.id}" class="edit-item-btn p-2 bg-blue-600 hover:bg-blue-700 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                            <button data-id="${item.id}" class="delete-item-btn p-2 bg-red-600 hover:bg-red-700 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>
                        </div>`;
                    adminMenuList.appendChild(itemElement);
                });
            }

            const updateTotal = () => {
                const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                totalPriceElement.textContent = formatCurrency(total);
            };

            const openModal = (modalElement) => {
                if (modalElement.id === 'admin-modal') configNameInput.value = lanchoneteConfig.name;
                modalElement.classList.remove('hidden');
                setTimeout(() => {
                   const innerDiv = modalElement.querySelector('.modal-enter');
                   if (innerDiv) {
                       innerDiv.classList.remove('modal-enter');
                       innerDiv.classList.add('modal-enter-active');
                   }
                }, 10);
            };

            const closeModal = (modalElement) => {
                const innerDiv = modalElement.querySelector('div[class*="modal-enter-active"]');
                if (innerDiv) {
                    innerDiv.classList.add('modal-leave-active');
                    setTimeout(() => {
                       modalElement.classList.add('hidden');
                       innerDiv.classList.remove('modal-leave-active');
                       innerDiv.classList.add('modal-enter');
                    }, 200);
                }
            };

            const addToCart = (itemId) => {
                const itemData = menuItems.find(item => item.id === itemId);
                if (!itemData || (itemData.stock ?? 0) <= 0) return;

                const existingItemInCart = cart.find(item => item.id === itemId);
                const quantityInCart = existingItemInCart ? existingItemInCart.quantity : 0;

                if (quantityInCart >= itemData.stock) {
                    alert('Quantidade máxima em estoque atingida.');
                    return;
                }

                if (existingItemInCart) {
                    existingItemInCart.quantity++;
                } else {
                    cart.push({ ...itemData, quantity: 1 });
                }
                renderCart();
            };

            const updateQuantity = (itemId, change) => {
                const cartItem = cart.find(item => item.id === itemId);
                if (!cartItem) return;

                if (change > 0) {
                    const itemData = menuItems.find(item => item.id === itemId);
                    if (cartItem.quantity >= (itemData.stock ?? 0)) {
                         alert('Quantidade máxima em estoque atingida.');
                        return;
                    }
                }

                cartItem.quantity += change;
                if (cartItem.quantity <= 0) cart = cart.filter(item => item.id !== itemId);
                
                renderCart();
            };

            const removeFromCart = (itemId) => {
                cart = cart.filter(item => item.id !== itemId);
                renderCart();
            };
            
            const submitOrder = async (customerName) => {
                if (!db) {
                    orderErrorMessage.textContent = "Erro de conexão. Tente novamente.";
                    return;
                }

                const submitButton = document.getElementById('submit-order-button');
                submitButton.disabled = true;
                submitButton.textContent = "Enviando...";
                orderErrorMessage.textContent = '';

                let finalPassword;

                try {
                    await runTransaction(db, async (transaction) => {
                        const itemsToUpdate = [];
                        const insufficientStockItems = [];

                        const itemRefs = cart.map(cartItem => doc(db, `artifacts/${appId}/public/data/cardapio`, cartItem.id));
                        const itemDocs = await Promise.all(itemRefs.map(ref => transaction.get(ref)));
                        
                        for (let i = 0; i < cart.length; i++) {
                            const cartItem = cart[i];
                            const itemDoc = itemDocs[i];

                            if (!itemDoc.exists()) throw new Error(`Item ${cartItem.name} não encontrado.`);
                            
                            const currentStock = itemDoc.data().stock ?? 0;
                            if (currentStock < cartItem.quantity) {
                                insufficientStockItems.push(cartItem.name);
                            }
                            
                            itemsToUpdate.push({ ref: itemDoc.ref, newStock: currentStock - cartItem.quantity });
                        }

                        if (insufficientStockItems.length > 0) {
                            throw new Error(`Estoque insuficiente para: ${insufficientStockItems.join(', ')}.`);
                        }
                        
                        const counterRef = doc(db, `artifacts/${appId}/public/data/counters`, 'orderCounter');
                        const counterDoc = await transaction.get(counterRef);
                        let newPassword = 1;
                        if (counterDoc.exists()) {
                            newPassword = counterDoc.data().currentNumber + 1;
                            transaction.update(counterRef, { currentNumber: newPassword });
                        } else {
                            transaction.set(counterRef, { currentNumber: 1 });
                        }
                        finalPassword = newPassword;
                        
                        itemsToUpdate.forEach(item => transaction.update(item.ref, { stock: item.newStock }));

                        const order = {
                            customerName: customerName,
                            password: newPassword,
                            items: cart,
                            total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                            status: 'pendente',
                            createdAt: serverTimestamp()
                        };
                        
                        const orderRef = doc(collection(db, `artifacts/${appId}/public/data/pedidos`));
                        transaction.set(orderRef, order);
                    });

                    orderPasswordElement.textContent = finalPassword;
                    closeModal(customerNameModal);
                    openModal(orderModal);
                    cart = [];
                    renderCart();

                } catch (e) {
                    console.error("ERRO DETALHADO AO ADICIONAR PEDIDO: ", e);
                    orderErrorMessage.textContent = e.message.includes('Estoque insuficiente') ? e.message : "Falha ao enviar. Verifique as permissões do Firebase.";
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = "Confirmar Pedido";
                }
            };

            const handleEditItem = (itemId) => {
                const item = menuItems.find(i => i.id === itemId);
                if(item) {
                    editingItemId = item.id;
                    document.getElementById('item-id').value = item.id;
                    document.getElementById('item-name').value = item.name;
                    document.getElementById('item-description').value = item.description;
                    document.getElementById('item-price').value = item.price;
                    document.getElementById('item-stock').value = item.stock ?? 0;
                    formTitle.textContent = "Editar Item";
                    cancelEditBtn.classList.remove('hidden');
                }
            };
            
            const handleDeleteItem = async (itemId) => {
                if (!db) return alert("Erro de conexão.");
                if (confirm('Tem certeza que deseja apagar este item do cardápio?')) {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/cardapio`, itemId));
                    } catch (error) {
                        console.error("Erro ao apagar item: ", error);
                        alert("Falha ao apagar item. Verifique as permissões no Firebase.");
                    }
                }
            };

            const resetForm = () => {
                menuItemForm.reset();
                editingItemId = null;
                document.getElementById('item-id').value = '';
                formTitle.textContent = "Adicionar Novo Item";
                cancelEditBtn.classList.add('hidden');
            }
            
            // --- EVENT LISTENERS ---
            document.body.addEventListener('click', (event) => {
                const target = event.target.closest('button');
                if (!target) return;
                if (target.id === 'copy-pix-button') {
                    const pixKeyInput = document.getElementById('pix-key-input');
                    const copyPixText = document.getElementById('copy-pix-text');
                    pixKeyInput.select();
                    pixKeyInput.setSelectionRange(0, 99999);
                    try {
                        document.execCommand('copy');
                        copyPixText.textContent = 'Copiado!';
                        target.classList.replace('bg-indigo-600', 'bg-green-600');
                        setTimeout(() => {
                            copyPixText.textContent = 'Copiar';
                            target.classList.replace('bg-green-600', 'bg-indigo-600');
                        }, 2000);
                    } catch (err) {
                        console.error('Falha ao copiar a chave Pix:', err);
                    }
                    return;
                }
                const itemId = target.dataset.id;
                if (target.classList.contains('add-to-cart-btn')) addToCart(itemId);
                if (target.classList.contains('increase-quantity-btn')) updateQuantity(itemId, 1);
                if (target.classList.contains('decrease-quantity-btn')) updateQuantity(itemId, -1);
                if (target.classList.contains('remove-from-cart-btn')) removeFromCart(itemId);
                if (target.classList.contains('edit-item-btn')) handleEditItem(itemId);
                if (target.classList.contains('delete-item-btn')) handleDeleteItem(itemId);
            });
            
            checkoutButton.addEventListener('click', () => {
                if (cart.length > 0) openModal(customerNameModal);
            });

            customerNameForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const customerName = document.getElementById('customer-name').value.trim();
                if (customerName) {
                    submitOrder(customerName);
                }
            });

            cancelNameModalButton.addEventListener('click', () => {
                closeModal(customerNameModal);
                customerNameForm.reset();
                orderErrorMessage.textContent = '';
            });

            adminButton.addEventListener('click', () => openModal(passwordModal));
            
            closeAdminModalButton.addEventListener('click', () => closeModal(adminModal));
            
            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const passwordInput = document.getElementById('admin-password');
                const enteredPassword = passwordInput.value;
                const correctPassword = 'admin'; // Senha para o painel. Mude se desejar.

                if (enteredPassword === correctPassword) {
                    closeModal(passwordModal);
                    openModal(adminModal);
                    passwordForm.reset();
                    passwordErrorMessage.textContent = '';
                } else {
                    passwordErrorMessage.textContent = 'Senha incorreta.';
                    passwordForm.reset();
                }
            });

            cancelPasswordModalButton.addEventListener('click', () => {
                closeModal(passwordModal);
                passwordForm.reset();
                passwordErrorMessage.textContent = '';
            });

            cancelEditBtn.addEventListener('click', resetForm);

            configForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) return alert("Erro de conexão.");

                const newName = configNameInput.value.trim();
                if (newName) {
                     const submitButton = configForm.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    try {
                        await setDoc(doc(db, `artifacts/${appId}/public/data/config`, "lanchonete"), { name: newName });
                        const originalText = submitButton.textContent;
                        submitButton.textContent = 'Salvo!';
                        setTimeout(() => {
                           submitButton.textContent = originalText;
                           submitButton.disabled = false;
                        }, 1500);
                    } catch (error) {
                        console.error("Erro ao salvar nome:", error);
                        alert("Falha ao salvar nome. Verifique as permissões no Firebase.");
                        submitButton.disabled = false;
                    }
                }
            });

            menuItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!db) return alert("Erro de conexão.");

                const formData = {
                    name: document.getElementById('item-name').value,
                    description: document.getElementById('item-description').value,
                    price: parseFloat(document.getElementById('item-price').value),
                    stock: parseInt(document.getElementById('item-stock').value)
                };

                try {
                    if (editingItemId) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/cardapio`, editingItemId), formData);
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/cardapio`), formData);
                    }
                    resetForm();
                } catch (error) {
                    console.error("Erro ao salvar item:", error);
                    alert("Falha ao salvar o item. Verifique as permissões no Firebase.");
                }
            });

            // --- INICIALIZAÇÃO DA APLICAÇÃO (UI) ---
            rerenderAll();

            // --- INICIALIZAÇÃO FIREBASE (ÚLTIMO PASSO) ---
            (async () => {
                try {
                    const firebaseConfigStr = typeof __firebase_config !== 'undefined' 
                        ? __firebase_config 
                        : JSON.stringify({
                            apiKey: "AIzaSyAg3rt06y_BmN521KMtPJQLMEp3yIEt0FQ",
                            authDomain: "enraizadas-95d63.firebaseapp.com",
                            projectId: "enraizadas-95d63",
                            storageBucket: "enraizadas-95d63.appspot.com",
                            messagingSenderId: "93361321737",
                            appId: "1:93361321737:web:e4aac6bbf90354f58585d8"
                        });
                    const firebaseConfig = JSON.parse(firebaseConfigStr);

                    if (!firebaseConfig.apiKey) {
                        throw new Error("Configuração do Firebase não foi encontrada ou é inválida.");
                    }

                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    const auth = getAuth(app);
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    console.log("Firebase inicializado e autenticado com sucesso.");
                    listenToMenu(); 
                    listenToConfig();

                } catch (error) {
                    console.error("Erro ao inicializar o Firebase.", error);
                    if(checkoutButton) {
                        checkoutButton.textContent = "Sistema Offline";
                        checkoutButton.disabled = true;
                        checkoutButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                        checkoutButton.classList.add('bg-gray-500', 'cursor-not-allowed');
                    }
                }
            })();

            const listenToMenu = () => {
                if (!db) return;
                const q = query(collection(db, `artifacts/${appId}/public/data/cardapio`));
                onSnapshot(q, (snapshot) => {
                    const tempMenu = [];
                    snapshot.forEach((doc) => {
                        tempMenu.push({ id: doc.id, ...doc.data() });
                    });
                    menuItems = tempMenu;
                    rerenderAll();
                }, (error) => {
                    console.error("Erro ao buscar cardápio em tempo real: ", error);
                     menuContainer.innerHTML = `<p class="text-red-400 col-span-full text-center">Erro de permissão ao carregar o cardápio. Verifique as Regras de Segurança no seu painel do Firebase.</p>`;
                });
            };

            const listenToConfig = () => {
                if (!db) return;
                const configRef = doc(db, `artifacts/${appId}/public/data/config`, 'lanchonete');
                onSnapshot(configRef, (docSnap) => {
                    if (docSnap.exists()) {
                        lanchoneteConfig = docSnap.data();
                        renderLanchoneteName();
                    } else {
                        (async () => {
                           try {
                               await setDoc(configRef, { name: "Lanchonete Sabor Digital" });
                           } catch(e){ console.error("Erro ao criar config inicial:", e); alert("Falha ao criar configuração inicial. Verifique as permissões no Firebase.")}
                        })();
                    }
                }, (error) => {
                    console.error("Erro ao buscar configurações em tempo real: ", error);
                     alert("Erro de permissão ao carregar as configurações. Verifique as Regras de Segurança no seu painel do Firebase.");
                });
            };

        });
    </script>
</body>
</html>

